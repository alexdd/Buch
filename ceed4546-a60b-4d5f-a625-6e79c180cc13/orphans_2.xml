<?xml version="1.0" encoding="UTF-8"?><elements><element id="96a87429-ac99-41bc-bba8-0fb8572cdbc3d7e30">&lt;education-system&gt; &lt;administrative-regions&gt; [...] &lt;dministrative-region id=\"31\"name=\"Bavaria\"&gt; &lt;shools&gt; &lt;school id=\"45\"&gt; &lt;teachers&gt; &lt;teacher id=\"576\"\/&gt; &lt;teacher id=\"345\"\/&gt; &lt;teacher id=\"12\"\/&gt; &lt;\/teachers&gt; &lt;\/school&gt; &lt;school id=\"36\"&gt; &lt;teachers&gt; &lt;teacher id=\"576\"\/&gt; &lt;teacher id=\"8\"\/&gt; &lt;\/teachers&gt; &lt;\/school&gt; [...] &lt;\/shools&gt; &lt;\/dministrative-region&gt; [...] &lt;\/administrative-regions&gt; &lt;\/education-system&gt;</element><element id="648b89f6-0c4a-4a99-b98e-8c4ed2519bf1d7e34">&lt;teachers&gt; [...] &lt;teacher id=\"576\"&gt; &lt;first-name&gt;Alfons&lt;\/first-name&gt; &lt;last-name&gt;Blimetsrieder&lt;\/last-name&gt; &lt;subjects&gt; &lt;subject&gt;Biology&lt;\/subject&gt; &lt;subject&gt;Math&lt;\/subject&gt; &lt;subject&gt;Sport&lt;\/subject&gt; &lt;\/subjects&gt; &lt;suspended&gt;2017-12-31&lt;\/suspended&gt; [...] &lt;\/teacher&gt; [...] &lt;\/teachers&gt;</element><element id="d31daaae-1b3a-4a9f-9937-342d21374efdd7e38">&lt;schools&gt; [...] &lt;school id=\"45\"&gt; &lt;name&gt;Gymnasium Bad Aibling&lt;\/name&gt; &lt;type&gt;Oberschule&lt;\/type&gt; [...] &lt;\/school&gt; [...] &lt;\/schools&gt;</element><element id="f2221330-52bd-4dcb-9fd5-0b5d46cfbca5d7e43">&lt;?xml version=\"1.0\"encoding=\"UTF-8\"?&gt; &lt;xsl:stylesheet version=\"2.0\"xmlns:xsl=\"http:\/\/www.w3.org\/1999\/XSL\/Transform\"exclude-result-prefixes=\"#all\"&gt; &lt;xsl:output indent=\"yes\"method=\"xml\"\/&gt; &lt;xsl:strip-space elements=\"*\"\/&gt; &lt;xsl:param name=\"file-1\"required=\"yes\"\/&gt; &lt;xsl:param name=\"file-2\"required=\"yes\"\/&gt; &lt;xsl:param name=\"file-3\"required=\"yes\"\/&gt; &lt;xsl:variable name=\"files\"select=\"(doc($file-1), doc($file-2), doc($file-3))\"\/&gt; &lt;xsl:variable name=\"bavaria-region-ids\"select=\"(31, 58)\"\/&gt; &lt;xsl:key name=\"teachers\"match=\"teacher\"use=\"@id\"\/&gt; &lt;xsl:key name=\"schools\"match=\"school\"use=\"@id\"\/&gt; &lt;xsl:template name=\"main\"&gt; &lt;xsl:variable name=\"resolve-result\"&gt; &lt;xsl:apply-templates select=\"$files\/administrative-regions\"mode=\"resolve\"\/&gt; &lt;\/xsl:variable&gt; &lt;xsl:apply-templates select=\"$resolve-result\/administrative-regions\"\/&gt; &lt;\/xsl:template&gt; &lt;xsl:template match=\"administrative-region[not(@id = $bavaria-region-ids)]\"mode=\"resolve\"\/&gt; &lt;xsl:template match=\"school\"mode=\"resolve\"&gt; &lt;xsl:copy&gt; &lt;xsl:copy-of select=\"key('schools',@id, $files\/schools[1]\/root())\/node()\"\/&gt; &lt;xsl:apply-templates select=\"node()|@*\"mode=\"resolve\"\/&gt; &lt;\/xsl:copy&gt; &lt;\/xsl:template&gt; &lt;xsl:template match=\"teacher\"mode=\"resolve\"&gt; &lt;xsl:copy-of select=\"key('teachers',@id, $files\/teachers[1]\/root())\/node()\"\/&gt; &lt;\/xsl:template&gt; &lt;xsl:template match=\"teacher[suspended\/xs:date(.) le current-date()]\"\/&gt; &lt;xsl:template match=\"node()|@*\"mode=\"#all\"&gt; &lt;xsl:copy&gt; &lt;xsl:apply-templates mode=\"#current\"\/&gt; &lt;\/xsl:copy&gt; &lt;\/xsl:template&gt; &lt;\/xsl:stylesheet&gt;</element></elements>