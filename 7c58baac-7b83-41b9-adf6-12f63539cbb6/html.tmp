<div data-attribute-id="61bcaead-35e5-4f94-b719-e7708391915f" class="topic show_menu tags" data-element="topic" data-deletable="false" data-tektur-editor-id="52d0debc-6149-4ead-8d29-f3d129591e45"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div data-attribute-id="a1776d29-3de4-4aeb-9f82-1718bfdb333e" class="title pmarker tags" data-element="title" data-tektur-editor-id="56b418ec-39a5-4846-8705-8b47f1cd8fc6" contenteditable="true">Anlegen des Testszenarios auf der ML Konsole </div><div class="abstract optional show_menu tags" data-element="abstract" data-excluding="shortdesc" style="display:none" data-tektur-editor-id="a6e51fc7-c52a-445b-bcfc-190bcf94cfef"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="cef3de02-2a77-4e79-b36c-e729eb31f74e" contenteditable="true"></div></div><div data-attribute-id="daa84b7b-0e02-4448-adfa-1cd9e6b3e289" class="body show_menu tags" data-element="body" data-deletable="false" data-tektur-editor-id="4cf6e09c-40cc-4c33-89c4-ae2842cc170a"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="section tektur-wrapper tags" data-element="section" data-tektur-editor-id="7e198e76-d585-47d7-a17f-e20d13432f6d"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="2104ae8b-6b06-4e0c-902d-b3dcaca2482b" class="p pmarker tags" data-element="p" data-tektur-editor-id="9420cca4-a8aa-4498-8653-5471353ac803" contenteditable="true">Die Codefragmente aus dem vorherigen Kapitel sind folgend für eine ML Konsolensitzung aufbereitet:</div><ul data-attribute-id="30e67061-8ce2-46f0-9f22-1a2383c198dbd6e8" class="ul tags" data-element="ul" data-tektur-editor-id="499d18d5-0fe2-4c81-bc1d-4eaa93a24c6f"><li data-attribute-id="ee196cb3-bf51-41e8-99bb-598d51581f38d6e9" class="li tags" data-element="li" data-tektur-editor-id="95488869-ff01-4a99-a8e3-66025bab38bf"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="a626e0cb-bd49-489b-8765-cdb123a70a52d6e10" class="p pmarker tags" data-element="p" data-tektur-editor-id="baf58c78-212b-4890-ba07-248d47dc3bfa" contenteditable="true">Anlegen der temporalen Properties: <span class="bracket-tags-marker" id="3cb605da-963e-4cf3-bae4-b803718f9a4d">[[<span class="bracket-tags">code:validStart</span>]]</span>, <span class="bracket-tags-marker" id="40be3e39-7052-4c87-8850-efa0543df85b">[[<span class="bracket-tags">code:validEnd</span>]]</span>, <span class="bracket-tags-marker" id="24444110-3b77-42f6-a75a-0a4238b7c574">[[<span class="bracket-tags">code:systemStart</span>]]</span>, <span class="bracket-tags-marker" id="b37a3cf1-4af6-4847-b1ca-9682a825e8c4">[[<span class="bracket-tags">code:systemEnd</span>]]</span></div></li><li data-attribute-id="7274f315-72f7-4da1-9f05-e20309215803d6e12" class="li tags" data-element="li" data-tektur-editor-id="40fa9591-a501-4027-bae5-83e23b479e0e"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="7690410f-a848-48ac-9ac1-d2b0c3a7cbf5d6e13" class="p pmarker tags" data-element="p" data-tektur-editor-id="c6db2b9c-b853-417a-a9a1-38c69fd04301" contenteditable="true">Anlegen der Indizes zum Suchen über Zeitbereiche: <span class="bracket-tags-marker" id="61c2d6ec-fdae-4b86-8458-9d4068991371">[[<span class="bracket-tags">code:database-range-field-index("dateTime", "systemStart",...</span>]]</span></div></li><li data-attribute-id="e705edf3-6040-481a-ae1c-765a8a7d690cd6e15" class="li tags" data-element="li" data-tektur-editor-id="fc6f3ff6-8ffe-4cb2-9259-820973d3f20e"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="8659af6f-9564-4553-a739-941223db12d0d6e16" class="p pmarker tags" data-element="p" data-tektur-editor-id="afee8fe5-1781-4b67-90ea-0a29196783a0" contenteditable="true">Anlegen der zwei Zeitachsen <span class="bracket-tags-marker" id="c9b7f896-e40e-4db0-a5e9-2e272683fbfe">[[<span class="bracket-tags">code:system</span>]]</span> und <span class="bracket-tags-marker" id="7c88fef3-5a80-4e0e-ac6d-a5cc69ebc413">[[<span class="bracket-tags">code:valid</span>]]</span><span class="bracket-tags-marker" id="a85648fa-3cfe-408e-9aeb-48a611d8f65d">[[<span class="bracket-tags">xe1:Temporale Zeitachsen</span>]]</span></div></li><li data-attribute-id="9a60750c-65ee-48ce-9c7c-f2a1a7239f3ad6e18" class="li tags" data-element="li" data-tektur-editor-id="880bb0bf-405a-49ec-a5c8-3ca0e5151426"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="fc9beb7e-9542-46c0-ae1b-b797b1b3df50d6e19" class="p pmarker tags" data-element="p" data-tektur-editor-id="a25a0f49-9774-4e2f-bd9e-9a29ad189463" contenteditable="true">Anlegen der temporalen Collection <span class="bracket-tags-marker" id="2f3025d0-adc9-4ba2-978a-7f2f7adc5da4">[[<span class="bracket-tags">code:/perso-verluste</span>]]</span></div></li><li data-attribute-id="d96c5d9a-ca6f-415c-b4d8-b656361f8e44d6e19" class="li tags" data-element="li" data-tektur-editor-id="4debac78-29fc-45ec-98ca-83c68d4bf605"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="f7340d19-8dc9-4530-a6b8-40eab7f87459d6e20" class="p pmarker tags" data-element="p" data-tektur-editor-id="0c26a99e-8482-49d3-b148-08ac3aa2d857" contenteditable="true">Anlegen des Originals am 1.2.2019</div></li><li data-attribute-id="c3fd928f-428c-45b7-bb43-ffc9b7c4ed39d6e22" class="li tags" data-element="li" data-tektur-editor-id="7be42cd2-971a-472d-bcaf-00c4880e8e22"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="ded7a86f-a732-45dd-841d-ad7155ce16dad6e23" class="p pmarker tags" data-element="p" data-tektur-editor-id="1f47a700-e320-492c-abf6-98029cd8d3c2" contenteditable="true">Aktualisierung am 6.2.2019</div></li></ul><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="c7f91ff1-922d-498a-adbe-a554c038cfc8" contenteditable="true"></div><div class="pre"><div data-attribute-id="8ce317b6-4974-4841-b537-8d41bd9b97f1d6e25" data-attribute-xml_space="preserve" class="pre-content pmarker tags" data-element="pre" data-tektur-editor-id="af45bea7-939c-4c4f-97a9-027662d4e44d" contenteditable="true">xquery version "1.0-ml";

import module namespace admin = 
  "http://marklogic.com/xdmp/admin" at "/MarkLogic/admin.xqy";
import module namespace temporal = 
  "http://marklogic.com/xdmp/temporal" at "/MarkLogic/temporal.xqy";

declare namespace local = 'local:';
declare variable $db := "alex-test";

declare function local:create-temporal-fields()
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return 
    try {
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validEnd"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemEnd")))
    } catch ($err) {}
};

declare function local:create-range-index-fields() 
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return
    try {
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validEnd", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemEnd", "", fn:true())))
    } catch ($err) {}  
};

declare function local:create-axes()
{
  try {
    let $t1 := temporal:axis-create(
          "valid",
          cts:field-reference("validStart", "type=dateTime"),
          cts:field-reference("validEnd", "type=dateTime")),
        $t2 := temporal:axis-create(
          "system",
          cts:field-reference("systemStart", "type=dateTime"),
          cts:field-reference("systemEnd", "type=dateTime"))
     return ()
   } catch ($err) {}
};

declare function local:create-temporal-collection() 
{
  try {
    let $t:= temporal:collection-create("/perso-verluste", "system", "valid")
    return ()
  } catch ($err) {}
};

declare function local:insert-original()
{
  let $root := 
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gestohlen&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
     $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-01T08:23:11&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

declare function local:insert-update()
{
  let $root :=    
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gefunden&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
    $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-06T08:00:00&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

( xdmp:invoke-function(local:create-temporal-fields#0),
  xdmp:invoke-function(local:create-range-index-fields#0),
  xdmp:invoke-function(local:create-axes#0),
  xdmp:invoke-function(local:create-temporal-collection#0),
  xdmp:invoke-function(local:insert-original#0),
  xdmp:invoke-function(local:insert-update#0))</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="ec14b4f3-ecb6-4134-a366-b9aca2059a06" contenteditable="true"></div><div data-element="note" class="show_menu tags" data-tektur-editor-id="334f6654-6c5f-417f-a4a4-0cbe4b97ebeb"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="note"><div class="signal-word">NOTE</div><div class="hcontent"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="5a2c0418-3a17-42dc-a27e-78dda31bc7f6d6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="ac560bc3-fe6d-418f-a4ed-351e5e3ef8e9" contenteditable="true">Beachtenswert ist hier,</div><ol data-attribute-id="6b0d4055-b7e6-481d-bbc4-c4976f167cc1d6e30" class="ol tags" data-element="ol" data-tektur-editor-id="cba30a7b-0681-46b4-8df8-075c0e448ea1"><li data-attribute-id="7eea5145-1440-4422-a42d-51ebb42a4983d6e31" class="li tags" data-element="li" data-tektur-editor-id="3ea4eccf-320d-4431-aaca-ced55aac657a"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="0d69c9fe-a968-4023-919f-a333ec8d1b7dd6e32" class="p pmarker tags" data-element="p" data-tektur-editor-id="f6832e56-1203-47ca-b49d-acbc8b5e4a42" contenteditable="true">dass die einzelnen Schritte als Funktion über <span class="bracket-tags-marker" id="d14d964c-11fc-4c1e-b3b5-5850aed80244">[[<span class="bracket-tags">code:xdmp:invoke-function</span>]]</span> aufgerufen werden. Dieses Konstrukt wird normalerweise benutzt um eine Funktion <span class="bracket-tags-marker" id="d310c6d1-2146-41f2-b6a8-54bc170649c9">[[<span class="bracket-tags">link</span>]]</span>anonym<span class="bracket-tags-marker" id="7547de62-a4b5-49ef-9c73-0eebcc48a51e">[[<span class="bracket-tags">fn:https://de.wikipedia.org/wiki/Anonyme_Funktion*Wikipedia Artikel zum Begriff Anonyme Funktion</span>]]</span> zu deklarieren und als Transaktion<span class="bracket-tags-marker" id="8231ee3c-497e-461f-bf7f-7e313a9b540f">[[<span class="bracket-tags">xe1:Transaktionen</span>]]</span> aufzurufen. Marklogic bietet <span class="bracket-tags-marker" id="ecf4ecf6-124f-47b0-ba44-932c3a3f2919">[[<span class="bracket-tags">link</span>]]</span>weitere Möglichkeiten<span class="bracket-tags-marker" id="1add4380-00d5-480f-bcbd-a186af8a7bac">[[<span class="bracket-tags">fn:https://docs.marklogic.com/guide/app-dev/transactions*Arbeiten mit Transaktionen in MarkLogic Server</span>]]</span> transaktional zu arbeiten.</div></li><li data-attribute-id="5f188393-90f6-432c-b146-b4ebd9582927d6e34" class="li tags" data-element="li" data-tektur-editor-id="ec7824db-15a3-41bc-9c7c-d5be4bc1d0a7"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="da016534-d98c-4116-addc-a8933d7b4e5cd6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="1ebc695d-7fa5-41a5-a5c0-39eb49f80d6f" contenteditable="true">Um die 5 Tage zwiachen Verlustmeldung und Wiederauffinden zu simulieren, wurde zwischem dem Anlegen der Dokumente ein <span class="bracket-tags-marker" id="290e2036-86f4-4ed2-9edc-c161752ac207">[[<span class="bracket-tags">code:xdmp:sleep</span>]]</span> Statement eingefügt.</div></li></ol><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="eb64bdfb-c625-42be-986b-9d01343703aa" contenteditable="true"></div></div></div></div><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="48ff0142-18b5-4135-986c-b4f3baf3550ed6e37" class="p pmarker tags" data-element="p" data-tektur-editor-id="dcf4484c-693c-43f7-9eea-7bc367ff3637" contenteditable="true">Lassen wir diese Query auf einer frischen Datenbank laufen, so erhalten wir die folgendes Ergebnis:</div><div data-attribute-id="fe12f3f3-03bd-4499-a987-303d3a478839d6e41" class="fig show_menu tags" data-element="fig" data-tektur-editor-id="9cb07ad5-7092-401a-8468-c84e37a244ac"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="desc optional pmarker tags" data-element="desc" data-tektur-editor-id="7186681b-2d10-4ec7-ab8e-60b49ee14836" contenteditable="true">Nach der Ausführung obiger Query gibt es in der DB drei Dokumente, das Orginal, das Split-Dokument und die Aktualisierung. Das Split-Dokuments und das Originals sind als Vorgänger mit Suffix gekennzeichnet.</div><div class="image tags" data-element="image" style="display:none" data-attribute-id="5b3105f9-bcc4-4014-b7c9-c211e5da2909d6e42" data-attribute-href="temporal-documents.png" data-tektur-editor-id="ea73a5d7-e11e-4baa-95d0-3bec2f8746a9"></div><div class="title optional pmarker tags" data-element="title" style="display:none" data-tektur-editor-id="74f466eb-afe4-4880-96d9-ad1440d8f769" contenteditable="true"></div><table class="legend optional show_menu tags" data-element="legend" width="100%" style="display:none" data-tektur-editor-id="ac8d0655-1dac-4431-9090-2440796e61ff"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><tbody><tr class="legentry tags" data-element="legentry" data-tektur-editor-id="1ee43d60-988c-4891-9101-5c47182aa926"><td valign="top" class="leg-pos tags" data-element="leg-pos" width="10%" data-tektur-editor-id="6412cb34-88b0-4fbc-9cb2-0f1cb566a9d6"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="d086dde8-0c08-45d8-aaf9-ff96c8f0998d" contenteditable="true"></div></td><td valign="top" class="leg-name tags" data-element="leg-name" width="90%" data-tektur-editor-id="5c9beced-c24a-43b6-80aa-bf7d68b45126"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="c6551bbe-3a5b-4156-8353-61b1dc8c46b6" contenteditable="true"></div></td></tr></tbody></table></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="537f1e1a-5833-424a-a02c-180aee46eac4" contenteditable="true"></div></div></div></div>