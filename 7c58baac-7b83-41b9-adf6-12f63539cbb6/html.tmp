<div data-attribute-id="61bcaead-35e5-4f94-b719-e7708391915f" class="topic show_menu tags" data-element="topic" data-deletable="false" data-tektur-editor-id="d8a267bc-aee5-49f1-8636-d74c36b16934"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div data-attribute-id="a1776d29-3de4-4aeb-9f82-1718bfdb333e" class="title pmarker tags" data-element="title" data-tektur-editor-id="400e30d1-2d68-4ac2-bdec-54c75a883a2e" contenteditable="true">Anlegen des Testszenarios auf der ML Konsole</div><div class="abstract optional show_menu tags" data-element="abstract" data-excluding="shortdesc" style="display:none" data-tektur-editor-id="3ea71e5a-158d-432a-8dab-2532ccc3056e"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="bcb477a9-268b-438f-bf55-cdece3658d6b" contenteditable="true"></div></div><div data-attribute-id="daa84b7b-0e02-4448-adfa-1cd9e6b3e289" class="body show_menu tags" data-element="body" data-deletable="false" data-tektur-editor-id="6a1b4404-0569-4a7b-948a-803ab7d9f681"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="section tektur-wrapper tags" data-element="section" data-tektur-editor-id="dbaa883c-a1b1-4500-b86f-b4500899fccc"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="2104ae8b-6b06-4e0c-902d-b3dcaca2482b" class="p pmarker tags" data-element="p" data-tektur-editor-id="62865478-70c6-4b79-b54e-f39534383223" contenteditable="true">Die Codefragmente aus dem vorherigen Kapitel sind folgend für eine ML Konsolensitzung aufbereitet:</div><ul data-attribute-id="30e67061-8ce2-46f0-9f22-1a2383c198dbd6e8" class="ul tags" data-element="ul" data-tektur-editor-id="1e720ac4-c490-4d30-9603-3e3da0a0a036"><li data-attribute-id="ee196cb3-bf51-41e8-99bb-598d51581f38d6e9" class="li tags" data-element="li" data-tektur-editor-id="6664f8d3-55c1-4687-87cd-1d4a8c7e457c"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="a626e0cb-bd49-489b-8765-cdb123a70a52d6e10" class="p pmarker tags" data-element="p" data-tektur-editor-id="d76ccfc3-6d27-44cb-8c61-a3b3d4f5e95d" contenteditable="true">Anlegen der temporalen Properties: <span class="bracket-tags-marker" id="1310ee47-f8f2-43f5-883d-89d8161dffeb">[[<span class="bracket-tags">code:validStart</span>]]</span>, <span class="bracket-tags-marker" id="5da8d4dd-167a-41f5-909d-9f0d15a326b3">[[<span class="bracket-tags">code:validEnd</span>]]</span>, <span class="bracket-tags-marker" id="47206d55-04f5-44c8-83b1-0d8348bcb2c4">[[<span class="bracket-tags">code:systemStart</span>]]</span>, <span class="bracket-tags-marker" id="a1285cf1-82b7-4442-ba74-436cb4e7c572">[[<span class="bracket-tags">code:systemEnd</span>]]</span></div></li><li data-attribute-id="7274f315-72f7-4da1-9f05-e20309215803d6e12" class="li tags" data-element="li" data-tektur-editor-id="58969ea5-addc-4e0a-9f04-bc7fb89088a4"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="7690410f-a848-48ac-9ac1-d2b0c3a7cbf5d6e13" class="p pmarker tags" data-element="p" data-tektur-editor-id="da498c7f-f7ab-4288-9010-c6c109faf34d" contenteditable="true">Anlegen der Indizes zum Suchen über Zeitbereiche: <span class="bracket-tags-marker" id="a985de99-43ff-4845-944f-2f2c7ee98962">[[<span class="bracket-tags">code:database-range-field-index("dateTime", "systemStart",...</span>]]</span></div></li><li data-attribute-id="e705edf3-6040-481a-ae1c-765a8a7d690cd6e15" class="li tags" data-element="li" data-tektur-editor-id="a7620af7-cd26-4575-9105-925fd9cf15af"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="8659af6f-9564-4553-a739-941223db12d0d6e16" class="p pmarker tags" data-element="p" data-tektur-editor-id="63d146c8-9825-4e13-8cd7-87cb486e9a8d" contenteditable="true">Anlegen der zwei Zeitachsen <span class="bracket-tags-marker" id="ec79e073-746d-4d53-9d78-20f41998a2a5">[[<span class="bracket-tags">code:system</span>]]</span> und <span class="bracket-tags-marker" id="0f5fbb17-1a70-47ee-87f4-f6b6443886cc">[[<span class="bracket-tags">code:valid</span>]]</span><span class="bracket-tags-marker" id="b8c9611d-35bf-4bb5-9cb5-1da73c219998">[[<span class="bracket-tags">xe1:Temporale Zeitachsen</span>]]</span></div></li><li data-attribute-id="9a60750c-65ee-48ce-9c7c-f2a1a7239f3ad6e18" class="li tags" data-element="li" data-tektur-editor-id="e31213d6-0b72-4d18-9e66-cd88d9cfa3c1"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="fc9beb7e-9542-46c0-ae1b-b797b1b3df50d6e19" class="p pmarker tags" data-element="p" data-tektur-editor-id="8334dd7a-d873-4da0-9c64-3e2208a7b4b7" contenteditable="true">Anlegen der temporalen Collection <span class="bracket-tags-marker" id="4225a3c5-20b3-46ab-804c-dd17a11ee435">[[<span class="bracket-tags">code:/perso-verluste</span>]]</span></div></li><li data-attribute-id="d96c5d9a-ca6f-415c-b4d8-b656361f8e44d6e19" class="li tags" data-element="li" data-tektur-editor-id="a8a9e7a0-f42f-49a4-9997-582b42fddd16"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="f7340d19-8dc9-4530-a6b8-40eab7f87459d6e20" class="p pmarker tags" data-element="p" data-tektur-editor-id="eb67ed05-c51c-46ac-9b49-3e192e1c37b9" contenteditable="true">Anlegen des Originals am 1.2.2019</div></li><li data-attribute-id="c3fd928f-428c-45b7-bb43-ffc9b7c4ed39d6e22" class="li tags" data-element="li" data-tektur-editor-id="90de5594-fceb-4fd4-ae6d-bc679572ff28"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="ded7a86f-a732-45dd-841d-ad7155ce16dad6e23" class="p pmarker tags" data-element="p" data-tektur-editor-id="cbf41dcf-4b22-4657-b575-a9ced889d1a2" contenteditable="true">Aktualisierung am 6.2.2019</div></li></ul><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="296bcd44-335d-4a08-8e98-792f1798c5df" contenteditable="true"></div><div class="pre"><div data-attribute-id="5120c997-0d91-430d-b495-2ae71480b83cd7e25" data-attribute-xml_space="preserve" class="pre-content pmarker tags" data-element="pre" data-tektur-editor-id="56896c24-ac29-4fe5-ac15-2738a46016f5" contenteditable="true">xquery version "1.0-ml";

import module namespace admin = 
  "http://marklogic.com/xdmp/admin" at "/MarkLogic/admin.xqy";
import module namespace temporal = 
  "http://marklogic.com/xdmp/temporal" at "/MarkLogic/temporal.xqy";

declare namespace local = 'local:';
declare variable $db := "alex-test";

declare function local:create-temporal-fields()
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return 
    try {
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validEnd"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemEnd")))
    } catch ($err) {}
};

declare function local:create-range-index-fields() 
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return
    try {
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validEnd", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemEnd", "", fn:true())))
    } catch ($err) {}  
};

declare function local:create-axes()
{
  try {
    let $t1 := temporal:axis-create(
          "valid",
          cts:field-reference("validStart", "type=dateTime"),
          cts:field-reference("validEnd", "type=dateTime")),
        $t2 := temporal:axis-create(
          "system",
          cts:field-reference("systemStart", "type=dateTime"),
          cts:field-reference("systemEnd", "type=dateTime"))
     return ()
   } catch ($err) {}
};

declare function local:create-temporal-collection() 
{
  try {
    let $t:= temporal:collection-create("/perso-verluste", "system", "valid")
    return ()
  } catch ($err) {}
};

declare function local:insert-original()
{
  let $root := 
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gestohlen&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
     $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-01T08:23:11&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

declare function local:insert-update()
{
  let $root :=    
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gefunden&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
    $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-06T08:00:00&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

( xdmp:invoke-function(local:create-temporal-fields#0),
  xdmp:invoke-function(local:create-range-index-fields#0),
  xdmp:invoke-function(local:create-axes#0),
  xdmp:invoke-function(local:create-temporal-collection#0),
  xdmp:invoke-function(local:insert-original#0),
  xdmp:invoke-function(local:insert-update#0))</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="4e709de5-e93d-4f18-bb80-3841a6fad671" contenteditable="true"></div><div data-element="note" class="show_menu tags" data-tektur-editor-id="f1ab31cc-00f1-4e55-8607-59728ba563f6"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="note"><div class="signal-word">NOTE</div><div class="hcontent"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="5a2c0418-3a17-42dc-a27e-78dda31bc7f6d6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="7d469c60-ceb1-4f13-933d-3f9960774b07" contenteditable="true">Beachtenswert ist hier,</div><ol data-attribute-id="6b0d4055-b7e6-481d-bbc4-c4976f167cc1d6e30" class="ol tags" data-element="ol" data-tektur-editor-id="dd03559a-9b42-4cde-b02c-0f3299d4acbc"><li data-attribute-id="7eea5145-1440-4422-a42d-51ebb42a4983d6e31" class="li tags" data-element="li" data-tektur-editor-id="59237ac3-8389-4947-9dc8-e1892d0234d3"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="0d69c9fe-a968-4023-919f-a333ec8d1b7dd6e32" class="p pmarker tags" data-element="p" data-tektur-editor-id="0cb40f19-1634-4475-9651-2d2fa3eb7903" contenteditable="true">dass die einzelnen Schritte als Funktion über <span class="bracket-tags-marker" id="53b1a3dd-acf1-4fd5-8520-da53f9072ad1">[[<span class="bracket-tags">code:xdmp:invoke-function</span>]]</span> aufgerufen werden. Dieses Konstrukt wird normalerweise benutzt um eine Funktion <span class="bracket-tags-marker" id="0e3b583c-6364-47b9-aed6-5361ae2ffa86">[[<span class="bracket-tags">link</span>]]</span>anonym<span class="bracket-tags-marker" id="5dc58c51-505f-4f89-a140-87304f0a60b7">[[<span class="bracket-tags">fn:https://de.wikipedia.org/wiki/Anonyme_Funktion*Wikipedia Artikel zum Begriff Anonyme Funktion</span>]]</span> zu deklarieren und als Transaktion<span class="bracket-tags-marker" id="44b2d68b-fcd2-40f1-bab3-92e515e8d8c2">[[<span class="bracket-tags">xe1:Transaktionen</span>]]</span> aufzurufen. Marklogic bietet <span class="bracket-tags-marker" id="0ed89103-ab44-42a4-be2c-9567580252b8">[[<span class="bracket-tags">link</span>]]</span>weitere Möglichkeiten<span class="bracket-tags-marker" id="14acc233-a258-43ec-96d4-f1e1d797f209">[[<span class="bracket-tags">fn:https://docs.marklogic.com/guide/app-dev/transactions*Arbeiten mit Transaktionen in MarkLogic Server</span>]]</span> transaktional zu arbeiten.</div></li><li data-attribute-id="5f188393-90f6-432c-b146-b4ebd9582927d6e34" class="li tags" data-element="li" data-tektur-editor-id="360b26c4-3c4e-4ede-83ac-5f9d0c55fef7"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="da016534-d98c-4116-addc-a8933d7b4e5cd6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="710e3ea2-1aab-4c12-9997-35efb5014ad9" contenteditable="true">Um die 5 Tage zwiachen Verlustmeldung und Wiederauffinden zu simulieren, wurde zwischem dem Anlegen der Dokumente ein <span class="bracket-tags-marker" id="2015e749-2d85-4d12-8a98-373a999a5b6b">[[<span class="bracket-tags">code:xdmp:sleep</span>]]</span> Statement eingefügt.</div></li></ol><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="8ac184ef-fadb-4953-aad0-4bbcacdf10bf" contenteditable="true"></div></div></div></div><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="48ff0142-18b5-4135-986c-b4f3baf3550ed6e37" class="p pmarker tags" data-element="p" data-tektur-editor-id="74bf80cb-0e9f-48e2-a979-4fd22ee5dc9a" contenteditable="true">Lassen wir diese Query auf einer frischen Datenbank laufen, so erhalten wir die folgendes Ergebnis:</div><div data-attribute-id="fe12f3f3-03bd-4499-a987-303d3a478839d6e41" class="fig show_menu tags" data-element="fig" data-tektur-editor-id="b54bfea3-9640-43fe-937b-a3c34c93bfc3"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="desc optional pmarker tags" data-element="desc" data-tektur-editor-id="af2c0a63-32e4-4deb-9a1d-07de568c7460" contenteditable="true">Nach der Ausführung obiger Query gibt es in der DB drei Dokumente, das Orginal, das Split-Dokument und die Aktualisierung. Das Split-Dokuments und das Originals sind als Vorgänger mit Suffix gekennzeichnet.</div><div class="image tags" data-element="image" style="display:none" data-attribute-id="305c3a86-8f78-4e18-b17c-0a1a1741b9b5d7e42" data-attribute-href="temporal-documents.png" data-tektur-editor-id="80ca1106-a30a-4e66-afa3-3756abfdfffd"></div><div class="title optional pmarker tags" data-element="title" style="display:none" data-tektur-editor-id="a040124b-2ca4-4c93-9ddb-6eb156be45b4" contenteditable="true"></div><table class="legend optional show_menu tags" data-element="legend" width="100%" style="display:none" data-tektur-editor-id="75b0e6b6-5c33-4c72-91ac-0d91f008ee28"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><tbody><tr class="legentry tags" data-element="legentry" data-tektur-editor-id="b9d18db6-5400-4f2e-9982-503d4fed8db7"><td valign="top" class="leg-pos tags" data-element="leg-pos" width="10%" data-tektur-editor-id="e89c1b5d-76a8-4758-886a-20c693b7fcb5"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="f42b2040-ba98-43d8-bc14-031fd86844a1" contenteditable="true"></div></td><td valign="top" class="leg-name tags" data-element="leg-name" width="90%" data-tektur-editor-id="4fb3df55-b221-4b41-bc40-18500280787b"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="77b83638-9339-418b-98f8-3de0f2dc4c3f" contenteditable="true"></div></td></tr></tbody></table></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="0192d17a-9828-4f32-8585-dc8db76abd79" contenteditable="true"></div></div></div></div>