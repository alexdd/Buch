<div data-attribute-id="61bcaead-35e5-4f94-b719-e7708391915f" class="topic show_menu tags" data-element="topic" data-deletable="false" data-tektur-editor-id="66bc072e-6226-4b4c-81d0-bdfb1219c3f7"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div data-attribute-id="a1776d29-3de4-4aeb-9f82-1718bfdb333e" class="title pmarker tags" data-element="title" data-tektur-editor-id="a624f1ce-9272-40a1-81dd-94bca88d0133" contenteditable="true">Anlegen des Testszenarios auf der ML Konsole </div><div class="abstract optional show_menu tags" data-element="abstract" data-excluding="shortdesc" style="display:none" data-tektur-editor-id="7272e82f-fd92-4c85-bb3e-065bef230ec9"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="a72cd897-f8df-42a4-812e-30eea8d8dea9" contenteditable="true"></div></div><div data-attribute-id="daa84b7b-0e02-4448-adfa-1cd9e6b3e289" class="body show_menu tags" data-element="body" data-deletable="false" data-tektur-editor-id="bbadef2b-7a92-458e-8449-a48d1a6e92de"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="section tektur-wrapper tags" data-element="section" data-tektur-editor-id="8ef2f1f4-edd2-4970-b2e4-32bc8692e3f4"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="2104ae8b-6b06-4e0c-902d-b3dcaca2482b" class="p pmarker tags" data-element="p" data-tektur-editor-id="e7de80cf-e57d-40a8-92ad-7f1974507bc8" contenteditable="true">Die Codefragmente aus dem vorherigen Kapitel sind folgend für eine ML Konsolensitzung aufbereitet:</div><ul data-attribute-id="30e67061-8ce2-46f0-9f22-1a2383c198dbd6e8" class="ul tags" data-element="ul" data-tektur-editor-id="a2707635-c0a6-4cf0-959f-9bc27c26a3ca"><li data-attribute-id="ee196cb3-bf51-41e8-99bb-598d51581f38d6e9" class="li tags" data-element="li" data-tektur-editor-id="13a95648-4b3d-4446-a26b-c21dba1b6a07"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="a626e0cb-bd49-489b-8765-cdb123a70a52d6e10" class="p pmarker tags" data-element="p" data-tektur-editor-id="941f8c10-323d-41de-8ddf-64df4cef0351" contenteditable="true">Anlegen der temporalen Properties: <span class="bracket-tags-marker" id="a0c062af-e200-46e5-a4f2-ca2a351a9897">[[<span class="bracket-tags">code:validStart</span>]]</span>, <span class="bracket-tags-marker" id="33c567b1-f4ec-4bfc-9ae4-099554ecb6e5">[[<span class="bracket-tags">code:validEnd</span>]]</span>, <span class="bracket-tags-marker" id="6f31c794-73b2-479f-8292-7ea83758643a">[[<span class="bracket-tags">code:systemStart</span>]]</span>, <span class="bracket-tags-marker" id="ccd34abc-3e2d-40b8-a146-2c6b2f6e4d00">[[<span class="bracket-tags">code:systemEnd</span>]]</span></div></li><li data-attribute-id="7274f315-72f7-4da1-9f05-e20309215803d6e12" class="li tags" data-element="li" data-tektur-editor-id="1073e54a-ef11-46a1-a188-607258800c5c"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="7690410f-a848-48ac-9ac1-d2b0c3a7cbf5d6e13" class="p pmarker tags" data-element="p" data-tektur-editor-id="7b478988-2cdc-44a8-ab2b-0138342ba514" contenteditable="true">Anlegen der Indizes zum Suchen über Zeitbereiche: <span class="bracket-tags-marker" id="623fd770-9a53-4dca-998c-44e570433317">[[<span class="bracket-tags">code:database-range-field-index("dateTime", "systemStart",...</span>]]</span></div></li><li data-attribute-id="e705edf3-6040-481a-ae1c-765a8a7d690cd6e15" class="li tags" data-element="li" data-tektur-editor-id="49a1087f-6df0-4732-9d5d-6cd3faa5e889"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="8659af6f-9564-4553-a739-941223db12d0d6e16" class="p pmarker tags" data-element="p" data-tektur-editor-id="45d516c6-04f8-4256-9d96-1536474b8d05" contenteditable="true">Anlegen der zwei Zeitachsen <span class="bracket-tags-marker" id="f0e36dce-07ee-4f07-8bb9-d731aeafb4c4">[[<span class="bracket-tags">code:system</span>]]</span> und <span class="bracket-tags-marker" id="8fda7bad-e6ef-45a6-8979-3f63d88f5158">[[<span class="bracket-tags">code:valid</span>]]</span><span class="bracket-tags-marker" id="bc1fa39f-064c-4b56-a45d-0646bb25f1c1">[[<span class="bracket-tags">xe1:Temporale Zeitachsen</span>]]</span></div></li><li data-attribute-id="9a60750c-65ee-48ce-9c7c-f2a1a7239f3ad6e18" class="li tags" data-element="li" data-tektur-editor-id="794d1098-1e2f-4ebc-8a8f-2113b8909a6f"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="fc9beb7e-9542-46c0-ae1b-b797b1b3df50d6e19" class="p pmarker tags" data-element="p" data-tektur-editor-id="15a795a6-f943-4abe-82a6-75cfc7e03869" contenteditable="true">Anlegen der temporalen Collection <span class="bracket-tags-marker" id="d8f0d96f-1c85-41b5-80b1-28695dcf8f43">[[<span class="bracket-tags">code:/perso-verluste</span>]]</span></div></li><li data-attribute-id="d96c5d9a-ca6f-415c-b4d8-b656361f8e44d6e19" class="li tags" data-element="li" data-tektur-editor-id="d5a7d8b7-2a44-4b4a-90ac-72406184d73a"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="f7340d19-8dc9-4530-a6b8-40eab7f87459d6e20" class="p pmarker tags" data-element="p" data-tektur-editor-id="41b8966c-bb1b-4d06-a0a4-66dec3351dbe" contenteditable="true">Anlegen des Originals am 1.2.2019</div></li><li data-attribute-id="c3fd928f-428c-45b7-bb43-ffc9b7c4ed39d6e22" class="li tags" data-element="li" data-tektur-editor-id="eb4801fd-03d1-47dc-81d5-a6eb1c31010d"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="ded7a86f-a732-45dd-841d-ad7155ce16dad6e23" class="p pmarker tags" data-element="p" data-tektur-editor-id="f0055295-7b4a-436b-9165-5ae4b557acd3" contenteditable="true">Aktualisierung am 6.2.2019</div></li></ul><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="e38b973e-4df3-40f8-9111-716b9c6460bb" contenteditable="true"></div><div class="pre"><div data-attribute-id="1eb047a9-b575-4e4f-86f2-077d7a305b53d7e25" data-attribute-xml_space="preserve" class="pre-content pmarker tags" data-element="pre" data-tektur-editor-id="d07326ea-20b8-4446-9d7f-bef0631f57e8" contenteditable="true">xquery version "1.0-ml";

import module namespace admin = 
  "http://marklogic.com/xdmp/admin" at "/MarkLogic/admin.xqy";
import module namespace temporal = 
  "http://marklogic.com/xdmp/temporal" at "/MarkLogic/temporal.xqy";

declare namespace local = 'local:';
declare variable $db := "alex-test";

declare function local:create-temporal-fields()
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return 
    try {
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validEnd"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemEnd")))
    } catch ($err) {}
};

declare function local:create-range-index-fields() 
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return
    try {
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validEnd", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemEnd", "", fn:true())))
    } catch ($err) {}  
};

declare function local:create-axes()
{
  try {
    let $t1 := temporal:axis-create(
          "valid",
          cts:field-reference("validStart", "type=dateTime"),
          cts:field-reference("validEnd", "type=dateTime")),
        $t2 := temporal:axis-create(
          "system",
          cts:field-reference("systemStart", "type=dateTime"),
          cts:field-reference("systemEnd", "type=dateTime"))
     return ()
   } catch ($err) {}
};

declare function local:create-temporal-collection() 
{
  try {
    let $t:= temporal:collection-create("/perso-verluste", "system", "valid")
    return ()
  } catch ($err) {}
};

declare function local:insert-original()
{
  let $root := 
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gestohlen&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
     $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-01T08:23:11&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

declare function local:insert-update()
{
  let $root :=    
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gefunden&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
    $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-06T08:00:00&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

( xdmp:invoke-function(local:create-temporal-fields#0),
  xdmp:invoke-function(local:create-range-index-fields#0),
  xdmp:invoke-function(local:create-axes#0),
  xdmp:invoke-function(local:create-temporal-collection#0),
  xdmp:invoke-function(local:insert-original#0),
  xdmp:invoke-function(local:insert-update#0))</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="5561fa0f-4bea-49c6-a214-1eb306cb359e" contenteditable="true"></div><div data-element="note" class="show_menu tags" data-tektur-editor-id="79b26a8d-5f37-44a7-8224-9fa286b975f1"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="note"><div class="signal-word">NOTE</div><div class="hcontent"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="5a2c0418-3a17-42dc-a27e-78dda31bc7f6d6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="95d5ecb5-8394-422b-8f41-7ff5301c13f8" contenteditable="true">Beachtenswert ist hier,</div><ol data-attribute-id="6b0d4055-b7e6-481d-bbc4-c4976f167cc1d6e30" class="ol tags" data-element="ol" data-tektur-editor-id="0a6f7343-5c01-470a-8b3d-5d62b44d8c3b"><li data-attribute-id="7eea5145-1440-4422-a42d-51ebb42a4983d6e31" class="li tags" data-element="li" data-tektur-editor-id="f9eb149d-a809-4116-86f0-42b134ef9ec1"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="0d69c9fe-a968-4023-919f-a333ec8d1b7dd6e32" class="p pmarker tags" data-element="p" data-tektur-editor-id="acf9b674-860a-44f9-b10f-7406ff8ac297" contenteditable="true">dass die einzelnen Schritte als Funktion über <span class="bracket-tags-marker" id="7211c842-8cca-42f5-9ab1-13154077d0c7">[[<span class="bracket-tags">code:xdmp:invoke-function</span>]]</span> aufgerufen werden. Dieses Konstrukt wird normalerweise benutzt um eine Funktion <span class="bracket-tags-marker" id="bed212bf-68ce-4107-a16d-9f6fa9cdfb15">[[<span class="bracket-tags">link</span>]]</span>anonym<span class="bracket-tags-marker" id="1e8a2684-bad3-405a-8cec-a8ea4c3ef3d6">[[<span class="bracket-tags">fn:https://de.wikipedia.org/wiki/Anonyme_Funktion*Wikipedia Artikel zum Begriff Anonyme Funktion</span>]]</span> zu deklarieren und als Transaktion<span class="bracket-tags-marker" id="f81175c8-71e6-4e71-ae62-09035bf12608">[[<span class="bracket-tags">xe1:Transaktionen</span>]]</span> aufzurufen. Marklogic bietet <span class="bracket-tags-marker" id="be5cf168-48fa-42a0-9db5-b386edb431ee">[[<span class="bracket-tags">link</span>]]</span>weitere Möglichkeiten<span class="bracket-tags-marker" id="5e055293-9793-414b-8207-7e8a437251c6">[[<span class="bracket-tags">fn:https://docs.marklogic.com/guide/app-dev/transactions*Arbeiten mit Transaktionen in MarkLogic Server</span>]]</span> transaktional zu arbeiten.</div></li><li data-attribute-id="5f188393-90f6-432c-b146-b4ebd9582927d6e34" class="li tags" data-element="li" data-tektur-editor-id="d0c1879d-c49e-4773-a7ca-3e5e0e61f268"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="da016534-d98c-4116-addc-a8933d7b4e5cd6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="67a49950-496b-4324-95c7-d0890b5ae02c" contenteditable="true">Um die 5 Tage zwiachen Verlustmeldung und Wiederauffinden zu simulieren, wurde zwischem dem Anlegen der Dokumente ein <span class="bracket-tags-marker" id="8fbadb53-7d36-462b-9e81-823debc149e4">[[<span class="bracket-tags">code:xdmp:sleep</span>]]</span> Statement eingefügt.</div></li></ol><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="460ca2df-0163-46b8-aa29-b82dd65c25e0" contenteditable="true"></div></div></div></div><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="48ff0142-18b5-4135-986c-b4f3baf3550ed6e37" class="p pmarker tags" data-element="p" data-tektur-editor-id="f5172c47-db8d-4329-a4a1-b54d89e25ab0" contenteditable="true">Lassen wir diese Query auf einer frischen Datenbank laufen, so erhalten wir die folgendes Ergebnis:</div><div data-attribute-id="fe12f3f3-03bd-4499-a987-303d3a478839d6e41" class="fig show_menu tags" data-element="fig" data-tektur-editor-id="e61d6499-58ed-46d4-8025-10920a8b548b"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="desc optional pmarker tags" data-element="desc" data-tektur-editor-id="3b3ce783-5861-4ce5-b7c1-e99f485736a3" contenteditable="true">Nach der Ausführung obiger Query gibt es in der DB drei Dokumente, das Orginal, das Split-Dokument und die Aktualisierung. Das Split-Dokuments und das Originals sind als Vorgänger mit Suffix gekennzeichnet.</div><div class="image tags" data-element="image" style="display:none" data-attribute-id="cc69a041-4769-4925-a0aa-1c7a9ae28710d7e42" data-attribute-href="temporal-documents.png" data-tektur-editor-id="df5d3e5c-c821-46a3-a270-d9f091d1e8d4"></div><div class="title optional pmarker tags" data-element="title" style="display:none" data-tektur-editor-id="1197da62-8a34-46a8-9f3c-a0cb72fd43a7" contenteditable="true"></div><table class="legend optional show_menu tags" data-element="legend" width="100%" style="display:none" data-tektur-editor-id="fe2c1e62-f859-4a0f-b292-39e4c40ae5e2"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><tbody><tr class="legentry tags" data-element="legentry" data-tektur-editor-id="a0150030-d096-4ed5-8f4b-40941a843497"><td valign="top" class="leg-pos tags" data-element="leg-pos" width="10%" data-tektur-editor-id="506f28e7-f2c7-485d-894f-7267a073b705"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="7fa5b56b-afdc-4961-8276-9ed8cc045628" contenteditable="true"></div></td><td valign="top" class="leg-name tags" data-element="leg-name" width="90%" data-tektur-editor-id="b8e4deb4-63c5-4d14-a60e-2ffb904423b2"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="b206f0c1-b4e4-401e-b4c5-aff11cc94a56" contenteditable="true"></div></td></tr></tbody></table></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="12522d72-2e9a-4b61-ba09-71b4ca8b76c7" contenteditable="true"></div></div></div></div>