<div data-attribute-id="61bcaead-35e5-4f94-b719-e7708391915f" class="topic show_menu tags" data-element="topic" data-deletable="false" data-tektur-editor-id="62bcfdd6-eaf8-41e9-9718-6973feb8c301"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div data-attribute-id="a1776d29-3de4-4aeb-9f82-1718bfdb333e" class="title pmarker tags" data-element="title" data-tektur-editor-id="8f667770-984e-47be-be35-df2a48819fcf" contenteditable="true">Anlegen des Testszenarios auf der ML Konsole</div><div class="abstract optional show_menu tags" data-element="abstract" data-excluding="shortdesc" style="display:none" data-tektur-editor-id="67827cf8-9b97-428b-869b-444e267b4037"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="9d25fa68-ab61-469e-ac6f-ee62c1acbb9e" contenteditable="true"></div></div><div data-attribute-id="daa84b7b-0e02-4448-adfa-1cd9e6b3e289" class="body show_menu tags" data-element="body" data-deletable="false" data-tektur-editor-id="97954c41-d553-484c-b76f-380b832813bc"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="section tektur-wrapper tags" data-element="section" data-tektur-editor-id="faf407c6-d8b7-4176-8c5d-80bb4699b759"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="2104ae8b-6b06-4e0c-902d-b3dcaca2482b" class="p pmarker tags" data-element="p" data-tektur-editor-id="58a2a3bf-6382-44a6-90a7-36e65746f971" contenteditable="true">Die Codefragmente aus dem vorherigen Kapitel sind folgend für eine ML Konsolensitzung aufbereitet:</div><ul data-attribute-id="30e67061-8ce2-46f0-9f22-1a2383c198dbd6e8" class="ul tags" data-element="ul" data-tektur-editor-id="8aa73cd6-19d0-41e2-bbc7-989ec85bc1e2"><li data-attribute-id="ee196cb3-bf51-41e8-99bb-598d51581f38d6e9" class="li tags" data-element="li" data-tektur-editor-id="966adc4b-8c9a-4f5b-854a-f7a58891623d"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="a626e0cb-bd49-489b-8765-cdb123a70a52d6e10" class="p pmarker tags" data-element="p" data-tektur-editor-id="784ff439-9a6a-4b67-8295-aa9c4d49176e" contenteditable="true">Anlegen der temporalen Properties: [[code:validStart]], [[code:validEnd]], [[code:systemStart]], [[code:systemEnd]]</div></li><li data-attribute-id="7274f315-72f7-4da1-9f05-e20309215803d6e12" class="li tags" data-element="li" data-tektur-editor-id="a3343cbf-42e0-4981-bfea-3129b8461f76"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="7690410f-a848-48ac-9ac1-d2b0c3a7cbf5d6e13" class="p pmarker tags" data-element="p" data-tektur-editor-id="1d6b6851-76c3-43b8-ad0b-65951b7466ca" contenteditable="true">Anlegen der Indizes zum Suchen über Zeitbereiche: [[code:database-range-field-index("dateTime", "systemStart",...]]</div></li><li data-attribute-id="e705edf3-6040-481a-ae1c-765a8a7d690cd6e15" class="li tags" data-element="li" data-tektur-editor-id="9e7ac220-bdc4-4a7e-b963-f2c8a715770f"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="8659af6f-9564-4553-a739-941223db12d0d6e16" class="p pmarker tags" data-element="p" data-tektur-editor-id="8a291c95-f5de-4221-8176-625f794e3860" contenteditable="true">Anlegen der zwei Zeitachsen [[code:system]] und [[code:valid]][[xe1:Temporale Zeitachsen]]</div></li><li data-attribute-id="9a60750c-65ee-48ce-9c7c-f2a1a7239f3ad6e18" class="li tags" data-element="li" data-tektur-editor-id="2afb218c-3abf-464a-b560-db4f909e682a"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="fc9beb7e-9542-46c0-ae1b-b797b1b3df50d6e19" class="p pmarker tags" data-element="p" data-tektur-editor-id="b362de4a-cfa9-4d0a-9a35-de5747c11ae0" contenteditable="true">Anlegen der temporalen Collection [[code:/perso-verluste]]</div></li><li data-attribute-id="d96c5d9a-ca6f-415c-b4d8-b656361f8e44d6e19" class="li tags" data-element="li" data-tektur-editor-id="d7001cd3-8b9f-4143-b5c4-395554cbb9c7"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="f7340d19-8dc9-4530-a6b8-40eab7f87459d6e20" class="p pmarker tags" data-element="p" data-tektur-editor-id="66b69323-e05a-43a5-b589-6d09b3895a33" contenteditable="true">Anlegen des Originals am 1.2.2019</div></li><li data-attribute-id="c3fd928f-428c-45b7-bb43-ffc9b7c4ed39d6e22" class="li tags" data-element="li" data-tektur-editor-id="a2e82fd0-5985-4d34-9727-3ef301ec4454"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="ded7a86f-a732-45dd-841d-ad7155ce16dad6e23" class="p pmarker tags" data-element="p" data-tektur-editor-id="bfac3921-3d88-40e2-af47-ff44c8237f47" contenteditable="true">Aktualisierung am 6.2.2019</div></li></ul><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="5693d567-2f25-4ee7-9222-e3aa4e897d0d" contenteditable="true"></div><div class="pre"><div data-attribute-id="697ed302-ffb9-47c0-a0b4-aea9b1817a02d6e25" data-attribute-xml_space="preserve" class="pre-content pmarker tags" data-element="pre" data-tektur-editor-id="5614045a-54bc-4d26-a49c-422caf0626e7" contenteditable="true">xquery version "1.0-ml";

import module namespace admin = 
  "http://marklogic.com/xdmp/admin" at "/MarkLogic/admin.xqy";
import module namespace temporal = 
  "http://marklogic.com/xdmp/temporal" at "/MarkLogic/temporal.xqy";

declare namespace local = 'local:';
declare variable $db := "alex-test";

declare function local:create-temporal-fields()
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return 
    try {
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("validEnd"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemStart"))),
      admin:save-configuration(
        admin:database-add-field($config, $dbid, 
        admin:database-metadata-field("systemEnd")))
    } catch ($err) {}
};

declare function local:create-range-index-fields() 
{
  let $config := admin:get-configuration(),
      $dbid := xdmp:database($db)
  return
    try {
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "validEnd", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemStart", "", fn:true()))),
      admin:save-configuration(
        admin:database-add-range-field-index($config, $dbid, 
        admin:database-range-field-index("dateTime", "systemEnd", "", fn:true())))
    } catch ($err) {}  
};

declare function local:create-axes()
{
  try {
    let $t1 := temporal:axis-create(
          "valid",
          cts:field-reference("validStart", "type=dateTime"),
          cts:field-reference("validEnd", "type=dateTime")),
        $t2 := temporal:axis-create(
          "system",
          cts:field-reference("systemStart", "type=dateTime"),
          cts:field-reference("systemEnd", "type=dateTime"))
     return ()
   } catch ($err) {}
};

declare function local:create-temporal-collection() 
{
  try {
    let $t:= temporal:collection-create("/perso-verluste", "system", "valid")
    return ()
  } catch ($err) {}
};

declare function local:insert-original()
{
  let $root := 
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gestohlen&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
     $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-01T08:23:11&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

declare function local:insert-update()
{
  let $root :=    
    &#x3C;vorgang&#x3E;     
      &#x3C;perso-id&#x3E;XYZ&#x3C;/perso-id&#x3E;    
      &#x3C;name&#x3E;Alex Düsel&#x3C;/name&#x3E;   
      &#x3C;status&#x3E;gefunden&#x3C;/status&#x3E;
    &#x3C;/vorgang&#x3E;,
    $options :=   
    &#x3C;options xmlns="xdmp:document-insert"&#x3E;     
      &#x3C;metadata&#x3E;        
        &#x3C;map:map xmlns:map="http://marklogic.com/xdmp/map"&#x3E;          
          &#x3C;map:entry key="validStart"&#x3E;            
	          &#x3C;map:value&#x3E;2019-02-06T08:00:00&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;          
	        &#x3C;map:entry key="validEnd"&#x3E;            
	          &#x3C;map:value&#x3E;9999-12-31T11:59:59Z&#x3C;/map:value&#x3E;          
	        &#x3C;/map:entry&#x3E;         
         &#x3C;/map:map&#x3E;    
      &#x3C;/metadata&#x3E;  
    &#x3C;/options&#x3E;
  return  temporal:document-insert("/perso-verluste", 
                                   "duesel_alex_270774.xml", 
                                   $root, $options)
};

( xdmp:invoke-function(local:create-temporal-fields#0),
  xdmp:invoke-function(local:create-range-index-fields#0),
  xdmp:invoke-function(local:create-axes#0),
  xdmp:invoke-function(local:create-temporal-collection#0),
  xdmp:invoke-function(local:insert-original#0),
  xdmp:invoke-function(local:insert-update#0))</div></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="393e8771-6a1a-4c2d-bcb1-db07e4a23582" contenteditable="true"></div><div data-element="note" class="show_menu tags" data-tektur-editor-id="a37b9b2c-4352-4d51-b83d-2ad8e9805142"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="note"><div class="signal-word">NOTE</div><div class="hcontent"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="5a2c0418-3a17-42dc-a27e-78dda31bc7f6d6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="673046dc-5ddc-4275-9878-b634dbc8707a" contenteditable="true">Beachtenswert ist hier,</div><ol data-attribute-id="6b0d4055-b7e6-481d-bbc4-c4976f167cc1d6e30" class="ol tags" data-element="ol" data-tektur-editor-id="a15fa306-82ae-4dd8-b4f6-ea90c1a27afb"><li data-attribute-id="7eea5145-1440-4422-a42d-51ebb42a4983d6e31" class="li tags" data-element="li" data-tektur-editor-id="52cccbde-fe44-4cc1-8d1b-b8f95f211c9c"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="0d69c9fe-a968-4023-919f-a333ec8d1b7dd6e32" class="p pmarker tags" data-element="p" data-tektur-editor-id="c0ede19e-62df-4896-b01e-25a7c95c4171" contenteditable="true">dass die einzelnen Schritte als Funktion über [[code:xdmp:invoke-function]] aufgerufen werden. Dieses Konstrukt wird normalerweise benutzt um eine Funktion [[link]]anonym[[fn:https://de.wikipedia.org/wiki/Anonyme_Funktion*Wikipedia Artikel zum Begriff Anonyme Funktion]] zu deklarieren und als Transaktion[[xe1:Transaktionen]] aufzurufen. Marklogic bietet [[link]]weitere Möglichkeiten[[fn:https://docs.marklogic.com/guide/app-dev/transactions*Arbeiten mit Transaktionen in MarkLogic Server]] transaktional zu arbeiten.</div></li><li data-attribute-id="5f188393-90f6-432c-b146-b4ebd9582927d6e34" class="li tags" data-element="li" data-tektur-editor-id="e1d98d30-d658-4e99-9337-3281b4bc85d1"><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="da016534-d98c-4116-addc-a8933d7b4e5cd6e35" class="p pmarker tags" data-element="p" data-tektur-editor-id="6c357c5f-5642-4749-a8ad-5b05b5a39ff0" contenteditable="true">Um die 5 Tage zwiachen Verlustmeldung und Wiederauffinden zu simulieren, wurde zwischem dem Anlegen der Dokumente ein [[code:xdmp:sleep]] Statement eingefügt.</div></li></ol><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="d3abde8c-241d-4b49-92b3-5211ac063562" contenteditable="true"></div></div></div></div><div xmlns:xr="http://www.tekturcms.de/2012/xr/common" xmlns:xlink="http://www.w3.org/1999/xlink" data-attribute-id="48ff0142-18b5-4135-986c-b4f3baf3550ed6e37" class="p pmarker tags" data-element="p" data-tektur-editor-id="ce0c304d-861f-4395-83ab-ebc07359c6bd" contenteditable="true">Lassen wir diese Query auf einer frischen Datenbank laufen, so erhalten wir die folgendes Ergebnis:</div><div data-attribute-id="fe12f3f3-03bd-4499-a987-303d3a478839d6e41" class="fig show_menu tags" data-element="fig" data-tektur-editor-id="1f800958-dd6f-4759-8d12-75a1a0d98775"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><div class="desc optional pmarker tags" data-element="desc" data-tektur-editor-id="c29062a7-0249-4b35-b1ba-e585ac47c69d" contenteditable="true">Nach der Ausführung obiger Query gibt es in der DB drei Dokumente, das Orginal, das Split-Dokument und die Aktualisierung. Das Split-Dokuments und das Originals sind als Vorgänger mit Suffix gekennzeichnet.</div><div class="image tags" data-element="image" style="display:none" data-attribute-id="5fccfc21-d43c-47e9-8202-cf721d09ced7d6e42" data-attribute-href="temporal-documents.png" data-tektur-editor-id="48d83f3b-43ee-4041-ae72-c6f31da3a15a"></div><div class="title optional pmarker tags" data-element="title" style="display:none" data-tektur-editor-id="aeadcb71-2459-4211-980f-b1b4d65e2b07" contenteditable="true"></div><table class="legend optional show_menu tags" data-element="legend" width="100%" style="display:none" data-tektur-editor-id="1259efcd-75fa-43cb-a73e-8d139e4c4718"><div class="gui-optional-elements-button" contenteditable="false"><div class="menu-icon" style="display:none">+</div></div><tbody><tr class="legentry tags" data-element="legentry" data-tektur-editor-id="b8ec727c-9ab5-47ef-86d2-8d8137cb2c27"><td valign="top" class="leg-pos tags" data-element="leg-pos" width="10%" data-tektur-editor-id="ba4117c9-9e92-4ca4-9764-f6d761c440db"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="8bbc153d-f334-4241-954a-b78d4503ef2c" contenteditable="true"></div></td><td valign="top" class="leg-name tags" data-element="leg-name" width="90%" data-tektur-editor-id="a82f5d51-10c2-4001-a242-36442ddc3f75"><div class="pmarker placeholder text tags" data-element="p" data-tektur-editor-id="a7f65480-44df-4b19-b611-e573b3c0439f" contenteditable="true"></div></td></tr></tbody></table></div><div class="placeholder text pmarker tags" data-element="p" data-tektur-editor-id="3d3c8296-347c-420f-b798-f05a99c96f56" contenteditable="true"></div></div></div></div>